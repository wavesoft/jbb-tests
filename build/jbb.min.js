/* JBB Binary Bundle Loader - https://github.com/wavesoft/jbb-profile-three */
var JBBBinaryLoader=function(r){function t(i){if(e[i])return e[i].exports;var n=e[i]={exports:{},id:i,loaded:!1};return r[i].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var e={};return t.m=r,t.c=e,t.p="",t(0)}([function(r,t){"use strict";function e(r,t){if(t==v.S_1)return 1;if(t==v.S_001)return.01;var e=1;return t==v.S_R00&&(e=100),r>=0&&3>=r||6==r?127*e:32768*e}function i(r,t){var e=r.readStringLT(),i=new Blob([r.readTypedArray[p.UINT8](t)],{type:e});return URL.createObjectURL(i)}function n(r,t,e){var n=[p.UINT8,p.UINT16,p.UINT32,p.FLOAT64][t],a=r.readTypedNum[n]();if(0==e)return String.fromCharCode.apply(null,r.readTypedArray[p.UINT8](a));if(1==e)return String.fromCharCode.apply(null,r.readTypedArray[p.UINT16](a));if(2==e){var s=document.createElement("img");return s.src=i(r,a),s}if(4==e){var s=document.createElement("script");return s.src=i(r,a),s}if(7==e)return i(r,a);throw{name:"AssertError",message:"Unknown buffer type #"+e+"!",toString:function(){return this.name+": "+this.message}}}function a(r,t,e,i){if(0==e||1==e){var n=i;1==e&&(n=r.readTypedNum[p.UINT8]()|i<<8);var a=r.ot.ENTITIES[n];if(void 0==a)throw{name:"AssertError",message:"Could not found known object entity #"+n+"!",toString:function(){return this.name+": "+this.message}};var s=a[1](a[0]);r.iref_table.push(s);var u=d(r,t);return a[2](s,r.ot.PROPERTIES[n],u),s}if(2==e){var n=i<<8|r.readTypedNum[p.UINT8](),o=r.signature_table[n];if(void 0==o)throw{name:"AssertError",message:"Could not found simple object signature with id #"+n+"!",toString:function(){return this.name+": "+this.message}};var h={};r.iref_table.push(h);for(var f=d(r,t),c=0,l=o.length;l>c;c++)h[o[c]]=f[c];return h}if(3==e){var h={};r.iref_table.push(h);for(var o=[],l=r.readTypedNum[p.UINT16](),c=0;l>c;c++)o.push(r.readStringLT());r.signature_table.push(o);for(var f=d(r,t),c=0,l=o.length;l>c;c++)h[o[c]]=f[c];return h}}function s(r,t,e,i){var n=new Float32Array(e.length+1),a=t;n[0]=a;for(var s=0,u=e.length;u>s;s++)a+=e[s]/i,n[s+1]=a;return n}function u(r,t,e,i){var n=new i(e.length+1),a=t;n[0]=a;for(var s=0,u=e.length;u>s;s++)a+=e[s],n[s+1]=a;return n}function o(r,t,e){for(var i=r.readTypedNum[p.UINT8](),n=[],a="return {",s=0;i>s;s++){var u=r.readStringLT();n.push(u),a+="'"+u+"': props["+s+"][i],"}a+="}";for(var o=[],s=0;i>s;s++)o.push(d(r,t));for(var h=Function("props","i",a),f=[],s=0;e>s;s++)f.push(h(o,s));return f}function h(r,t,e){for(var i=0,n=[],a=0,s=10,u=0;e>a;){var h=r.u8[r.i8];if(120==(252&h))switch(r.i8++,s=3&h){case 0:u=r.readTypedNum[p.UINT8]()+1;break;case 1:break;case 2:u=r.readTypedNum[p.UINT16](),n=n.concat(o(r,t,u)),a+=u,s=10;break;default:throw{name:"AssertError",message:"Unknown primitive array flag #"+s+"!",toString:function(){return this.name+": "+this.message}}}else{var f=d(r,t);if(10!=s){switch(s){case 0:for(var i=0;u>i;i++)n.push(f);a+=u;break;case 1:n=n.concat(Array.prototype.slice.call(f)),a+=f.length;break;case 2:}s=10}else n.push(f),a+=1}}return n}function f(r,t,i){var n=(8&i)>>3==0?p.UINT16:p.UINT32,a=0==(1&i)?p.UINT16:p.UINT32,o=(48&i)>>4,f=7&i;if(0==(64&i)){var d=r.readTypedNum[n](),c=r.readTypedNum[m.FROM[f]](),l=r.readTypedArray[m.TO_DELTA[f]](d-1);return 6>f?u(r,c,l,g[m.FROM[f]]):s(r,c,l,e(f,o))}if(64==(112&i)){var d=r.readTypedNum[n]();return r.readTypedArray[f](d)}if(80==(112&i)){for(var d=r.readTypedNum[n](),c=r.readTypedNum[f](),y=new g[f](d),T=0;d>T;T++)y[T]=c;return y}if(96==(112&i)){var d=r.readTypedNum[n](),c=r.readTypedNum[m.FROM[f]](),l=r.readTypedArray[m.TO_DWS[f]](d),v=new g[m.FROM[f]](l);return v}if(112==(120&i)){var d=r.readTypedNum[p.UINT8](),l=r.readTypedArray[f](d);return l}if(120==(124&i))throw{name:"AssertError",message:"Encountered FLAG operator outside a primitive array!",toString:function(){return this.name+": "+this.message}};if(124==(126&i)){var d=r.readTypedNum[a]();return h(r,t,d)}return 126==(127&i)?[]:void 0}function d(r,t){var e=r.readTypedNum[p.UINT8]();if(0==(128&e))return f(r,t,127&e);if(128==(192&e))return a(r,t,(48&e)>>4,15&e);if(192==(224&e))return n(r,(24&e)>>3,7&e);if(224==(240&e)){var i=(15&e)<<16|r.readTypedNum[p.UINT16]();return r.iref_table[i]}if(240==(248&e))return r.readTypedNum[7&e]();if(248==(252&e))return A[3&e];if(252==(254&e))return I[2&e];if(254==(255&e)){var s=r.readStringLT();if(void 0==t[s])throw{name:"ImportError",message:"Cannot import undefined external reference "+s+"!",toString:function(){return this.name+": "+this.message}};return t[s]}}function c(r,t){for(;!r.eof();){var e=r.readTypedNum[p.UINT8]();switch(e){case 248:var i=r.prefix+r.readStringLT();t[i]=d(r,t);break;default:throw{name:"AssertError",message:"Unknown control operator #"+e+" at @"+r.i8+"!",toString:function(){return this.name+": "+this.message}}}}}function l(r,t){for(var e=r.length,i=Array(e),n=function(r,n){i[n]=r,0==--e&&t(null,i)},a=!1,s=0;s<r.length;s++)!function(e){var i=new XMLHttpRequest;i.open("GET",r[e]),i.responseType="arraybuffer",i.send(),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status)n(i.response,e);else{if(a)return;t("Error loading "+r[e]+": "+i.statusText,null),a=!0}}}(s)}var y=0,T=1,p={UINT8:0,INT8:1,UINT16:2,INT16:3,UINT32:4,INT32:5,FLOAT32:6,FLOAT64:7},m={FROM:[p.UINT16,p.INT16,p.UINT32,p.INT32,p.UINT32,p.INT32,p.FLOAT32,p.FLOAT32],TO_DWS:[p.UINT8,p.INT8,p.UINT8,p.INT8,p.UINT16,p.INT16,p.INT8,p.INT16],TO_DELTA:[p.INT8,p.INT8,p.INT8,p.INT8,p.INT16,p.INT16,p.INT8,p.INT16]},g=[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array],v=([Uint8Array,Int8Array,Uint8Array,Int8Array,Uint16Array,Int16Array,Int8Array,Int16Array],[Int8Array,Int8Array,Int8Array,Int8Array,Int16Array,Int16Array,Int8Array,Int16Array],{S_001:1,S_1:2,S_R:3,S_R00:4}),A=[void 0,null,!1,!0],I=[NaN],b=function(r,t){this.ot=t,this.prefix="",this.sparse=r instanceof Array;var e,i,n,a=24;if(this.sparse?(this.u8=new Uint8Array(r[0]),this.s8=new Int8Array(r[0]),this.u16=new Uint16Array(r[1]),this.s16=new Int16Array(r[1]),this.u32=new Uint32Array(r[2]),this.s32=new Int32Array(r[2]),this.f32=new Float32Array(r[2]),this.f64=new Float64Array(r[3]),e=new Uint16Array(r[0],0,a),i=new Uint32Array(r[0],0,a),n=r[0].byteLength):(this.u8=new Uint8Array(r),this.s8=new Int8Array(r),this.u16=new Uint16Array(r),this.s16=new Int16Array(r),this.u32=new Uint32Array(r),this.s32=new Int32Array(r),this.f32=new Float32Array(r),this.f64=new Float64Array(r),e=new Uint16Array(r),i=new Uint32Array(r),n=r.byteLength),this.magic=e[0],this.table_id=e[1],this.max64=i[1],this.max32=i[2],this.max16=i[3],this.max8=i[4],this.maxST=i[5],13122==this.magic)throw{name:"EndianessError",message:"Unfortunately the JBB format is currently only compatible with Little-Endian CPUs",toString:function(){return this.name+": "+this.message}};if(16947!=this.magic)throw{name:"DecodingError",message:"This does not look like a JBB archive! (Magic is 0x"+this.magic.toString(16)+")",toString:function(){return this.name+": "+this.message}};if(this.table_id!=this.ot.ID)throw{name:"DecodingError",message:"The object table specified does not match the object table in the binary bundle (0x"+this.table_id.toString(16)+")",toString:function(){return this.name+": "+this.message}};this.sparse?(this.i64=0,this.i32=0,this.i16=0,this.i8=a,this.iEnd=this.i8+this.max8,this.ofs8=this.i8,this.ofs16=this.i16,this.ofs32=this.i32,this.ofs64=this.i64):(this.i64=a,this.i32=this.i64+this.max64,this.i16=this.i32+this.max32,this.i8=this.i16+this.max16,this.iEnd=this.i8+this.max8,this.ofs8=this.i8,this.ofs16=this.i16,this.ofs32=this.i32,this.ofs64=this.i64,this.i16/=2,this.i32/=4,this.i64/=8),this.iref_table=[],this.signature_table=[],this.string_table=[];for(var s="",u=this.iEnd;n>u;u++){var o=this.u8[u];if(0==o){if(this.string_table.push(s),s="",this.string_table.length>=this.maxST)break}else s+=String.fromCharCode(o)}var h=this;this.readTypedNum=[function(){return h.u8[h.i8++]},function(){return h.s8[h.i8++]},function(){return h.u16[h.i16++]},function(){return h.s16[h.i16++]},function(){return h.u32[h.i32++]},function(){return h.s32[h.i32++]},function(){return h.f32[h.i32++]},function(){return h.f64[h.i64++]}],this.sparse?this.readTypedArray=[function(t){var e=h.i8;return h.i8+=t,new Uint8Array(r[0],e,t)},function(t){var e=h.i8;return h.i8+=t,new Int8Array(r[0],e,t)},function(t){var e=2*h.i16;return h.i16+=t,new Uint16Array(r[1],e,t)},function(t){var e=2*h.i16;return h.i16+=t,new Int16Array(r[1],e,t)},function(t){var e=4*h.i32;return h.i32+=t,new Uint32Array(r[2],e,t)},function(t){var e=4*h.i32;return h.i32+=t,new Int32Array(r[2],e,t)},function(t){var e=4*h.i32;return h.i32+=t,new Float32Array(r[2],e,t)},function(t){var e=8*h.i64;return h.i64+=t,new Float64Array(r[3],e,t)}]:this.readTypedArray=[function(t){var e=h.i8;return h.i8+=t,new Uint8Array(r,e,t)},function(t){var e=h.i8;return h.i8+=t,new Int8Array(r,e,t)},function(t){var e=2*h.i16;return h.i16+=t,new Uint16Array(r,e,t)},function(t){var e=2*h.i16;return h.i16+=t,new Int16Array(r,e,t)},function(t){var e=4*h.i32;return h.i32+=t,new Uint32Array(r,e,t)},function(t){var e=4*h.i32;return h.i32+=t,new Int32Array(r,e,t)},function(t){var e=4*h.i32;return h.i32+=t,new Float32Array(r,e,t)},function(t){var e=8*h.i64;return h.i64+=t,new Float64Array(r,e,t)}]};b.prototype.readStringLT=function(){var r=this.readTypedNum[p.UINT16]();if(r>=this.string_table.length)throw{name:"RangeError",message:"String ID is outside than the range of the string lookup table!",toString:function(){return this.name+": "+this.message}};return this.string_table[r]},b.prototype.eof=function(){return this.i8>=this.iEnd},b.prototype.where=function(){console.log("i8=",this.i8-this.ofs8," [U:",this.u8[this.i8],"0x"+this.u8[this.i8].toString(16),"/ S:",this.s8[this.i8],"]"),console.log("i16=",this.i16-this.ofs16/2," [U:",this.u16[this.i16],"/ S:",this.s16[this.i16],"]"),console.log("i32=",this.i32-this.ofs32/4," [U:",this.u32[this.i32],"/ S:",this.s32[this.i32],"/ F:",this.f32[this.i32],"]"),console.log("i64=",this.i64-this.ofs64/8," [F:",this.f64[this.i64],"]")};var N=function(r,t){this.database=t||{},this.queuedRequests=[],this.objectTable=r};N.prototype={constructor:N,add:function(r,t){var e=r.split("?"),i="",n=[];if(e.length>1&&(i="?"+e[1]),".jbbp"==e[0].substr(e[0].length-5).toLowerCase()){var a=e[0].substr(0,e[0].length-5);n=[a+".jbbp",a+"_b16.jbbp",a+"_b32.jbbp",a+"_b64.jbbp"]}else n=[e[0]+i];var s={callback:t,status:y,buffer:void 0,url:n};this.queuedRequests.push(s)},addByBuffer:function(r){var t={callback:void 0,status:T,buffer:r,url:void 0};this.queuedRequests.push(t)},load:function(r){this.__process(r)},__process:function(r){var t=this;if(r||(r=function(){}),0==this.queuedRequests.length)return void r(null,this);for(var e=!1,i=0;i<this.queuedRequests.length;i++)if(this.queuedRequests[i].status==y){e=!0;break}if(e)for(var n={counter:0},a=function(){0==--this.counter&&t.__process(r)}.bind(n),s=!1,i=0;i<this.queuedRequests.length;i++){var u=this.queuedRequests[i];u.status==y&&(n.counter++,l(u.url,function(t){return function(e,i){if(e){if(s)return;var n="Error downloading bundle: "+e;return t.callback&&t.callback(n,null),r&&r(n,null),void(s=!0)}t.buffer=i,1==i.length&&(t.buffer=i[0]),t.status=T,a()}}(u)))}else{for(var i=0;i<this.queuedRequests.length;i++){var u=this.queuedRequests[i];if(u.status==T){var o=new b(u.buffer,t.objectTable);c(o,t.database),u.callback&&u.callback(null,u.bundle)}}this.queuedRequests=[],r(null,this)}}},r.exports=N}]);