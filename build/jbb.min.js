/* JBB Binary Bundle Loader - https://github.com/wavesoft/jbb-profile-three */
var JBBBinaryLoader=function(t){function r(i){if(e[i])return e[i].exports;var n=e[i]={exports:{},id:i,loaded:!1};return t[i].call(n.exports,n,n.exports,r),n.loaded=!0,n.exports}var e={};return r.m=t,r.c=e,r.p="",r(0)}([function(t,r,e){"use strict";function i(t,r){if(r===A.S_1)return 1;if(r===A.S_001)return.01;var e=1;return r===A.S_R00&&(e=100),t>=0&&3>=t||6===t?127*e:32768*e}function n(t,r){var e=t.readStringLT(),i=new Blob([t.readTypedArray[v.UINT8](r)],{type:e});return URL.createObjectURL(i)}function s(t,r,e){var i=[v.UINT8,v.UINT16,v.UINT32,v.FLOAT64][r],s=t.readTypedNum[i]();if(0===e)return String.fromCharCode.apply(null,t.readTypedArray[v.UINT8](s));if(1===e)return String.fromCharCode.apply(null,t.readTypedArray[v.UINT16](s));if(2===e){var a=document.createElement("img");return a.src=n(t,s),a}if(4===e){var a=document.createElement("script");return a.src=n(t,s),a}if(7===e)return n(t,s);throw{name:"AssertError",message:"Unknown buffer type #"+e+"!",toString:function(){return this.name+": "+this.message}}}function a(t,r,e){if(!(32&e&&32!==(48&e))){var i=e;32&e&&(i=t.readTypedNum[v.UINT8]()|(15&e)<<8);var n=t.ot.ENTITIES[i];if(void 0===n)throw{name:"AssertError",message:"Could not found known object entity #"+i+"!",toString:function(){return this.name+": "+this.message}};var s=n[1](n[0]);t.iref_table.push(s);var a=c(t,r);return n[2](s,t.ot.PROPERTIES[i],a),s}if(56===(60&e)){var u=3&e;switch(u){case 0:var o=t.readTypedNum[v.FLOAT64]();10*t.readTypedNum[v.INT8]();return new Date(o);default:throw{name:"AssertError",message:"Unknown primitive object with POID #"+u+"!",toString:function(){return this.name+": "+this.message}}}}else{if(48===(56&e)){var i=(7&e)<<8|t.readTypedNum[v.UINT8](),h=t.factory_plain[i];if(void 0===h)throw{name:"AssertError",message:"Could not found simple object signature with id #"+i+"!",toString:function(){return this.name+": "+this.message}};var f=c(t,r);return h(f)}if(63===e){for(var l="return {",d=t.readTypedNum[v.UINT16](),y=0;d>y;y++)l+="'"+t.readStringLT()+"': values["+y+"],";l+="}";var h=Function("values",l);t.plain_factory_table.push(h);var f=c(t,r);return h(f)}}}function u(t,r,e,i){var n=new Float32Array(e.length+1),s=r;n[0]=s;for(var a=0,u=e.length;u>a;a++)s+=e[a]/i,n[a+1]=s;return n}function o(t,r,e,i){var n=new i(e.length+1),s=r;n[0]=s;for(var a=0,u=e.length;u>a;a++)s+=e[a],n[a+1]=s;return n}function h(t,r,e){var i=t.readTypedNum[v.UINT16](),n=t.signature_table[i],s=t.factory_plain_bulk[i];if(!n)throw{name:"AssertError",message:"Unknown plain object with signature #"+i+"!",toString:function(){return this.name+": "+this.message}};for(var a=[],u=0,o=n.length;o>u;u++)a.push(c(t,r));for(var h=[],u=0;e>u;u++)h.push(s(a,u));return h}function f(t,r,e){for(var i=0,n=[],s=0,a=10,u=0;e>s;){var o=0|t.u8[t.i8];if(120===(252&o))switch(t.i8++,a=3&o|0){case 0:u=0|t.readTypedNum[v.UINT8](),u++;break;case 1:break;case 2:u=0|t.readTypedNum[v.UINT16](),n=n.concat(h(t,r,u)),s+=u,a=10;break;default:throw{name:"AssertError",message:"Unknown primitive array flag #"+a+"!",toString:function(){return this.name+": "+this.message}}}else{var f=c(t,r);if(10!==a){switch(a){case 0:for(var i=0;u>i;i++)n.push(f);s+=u;break;case 1:n=n.concat(Array.prototype.slice.call(f)),s+=f.length;break;case 2:}a=10}else n.push(f),s+=1}}return n}function l(t,r,e){var n=(8&e)>>3===0?v.UINT16:v.UINT32,s=0===(1&e)?v.UINT16:v.UINT32,a=(48&e)>>4,h=7&e;if(0===(64&e)){var l=t.readTypedNum[n](),c=t.readTypedNum[g.FROM[h]](),d=t.readTypedArray[g.TO_DELTA[h]](l-1);return 6>h?o(t,c,d,b[g.FROM[h]]):u(t,c,d,i(h,a))}if(64===(112&e)){var l=t.readTypedNum[n]();return t.readTypedArray[h](l)}if(80===(112&e)){for(var l=t.readTypedNum[n](),c=t.readTypedNum[h](),y=new b[h](l),T=0;l>T;T++)y[T]=c;return y}if(96===(112&e)){var l=t.readTypedNum[n](),c=t.readTypedNum[g.FROM[h]](),d=t.readTypedArray[g.TO_DWS[h]](l),p=new b[g.FROM[h]](d);return p}if(112===(120&e)){var l=t.readTypedNum[v.UINT8](),d=t.readTypedArray[h](l);return d}if(120===(124&e))throw{name:"AssertError",message:"Encountered FLAG operator outside a primitive array!",toString:function(){return this.name+": "+this.message}};if(124===(126&e)){var l=0|t.readTypedNum[s]();return f(t,r,l)}return 126===(127&e)?[]:void 0}function c(t,r){var e=t.readTypedNum[v.UINT8]();if(0===(128&e))return l(t,r,127&e);if(128===(192&e))return a(t,r,63&e);if(192===(224&e))return s(t,(24&e)>>3,7&e);if(224===(240&e)){var i=(15&e)<<16|t.readTypedNum[v.UINT16]();return t.iref_table[i]}if(240===(248&e))return t.readTypedNum[7&e]();if(248===(252&e))return I[3&e];if(252===(254&e))return N[2&e];if(254===(255&e)){var n=t.readStringLT();if(void 0===r[n])throw{name:"ImportError",message:"Cannot import undefined external reference "+n+"!",toString:function(){return this.name+": "+this.message}};return r[n]}}function d(t,r){for(;!t.eof();){var e=t.readTypedNum[v.UINT8]();switch(e){case 248:var i=t.prefix+t.readStringLT();r[i]=c(t,r);break;default:throw{name:"AssertError",message:"Unknown control operator #"+e+" at @"+t.i8+"!",toString:function(){return this.name+": "+this.message}}}}}function y(t,r){var e=t.length,i=Array(e),n=!1;return t.forEach(function(s,a){var u=new XMLHttpRequest;u.open("GET",t[a]),u.responseType="arraybuffer",u.send(),u.addEventListener("readystatechange",function(){if(4===u.readyState)if(200===u.status)i[a]=u.response,0===--e&&r(null);else{if(n)return;r("Error loading "+t[a]+": "+u.statusText),n=!0}})}),i}var T=e(1),p=0,m=1,v={UINT8:0,INT8:1,UINT16:2,INT16:3,UINT32:4,INT32:5,FLOAT32:6,FLOAT64:7},g={FROM:[v.UINT16,v.INT16,v.UINT32,v.INT32,v.UINT32,v.INT32,v.FLOAT32,v.FLOAT32],TO_DWS:[v.UINT8,v.INT8,v.UINT8,v.INT8,v.UINT16,v.INT16,v.INT8,v.INT16],TO_DELTA:[v.INT8,v.INT8,v.INT8,v.INT8,v.INT16,v.INT16,v.INT8,v.INT16]},b=[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array],A=([Uint8Array,Int8Array,Uint8Array,Int8Array,Uint16Array,Int16Array,Int8Array,Int16Array],[Int8Array,Int8Array,Int8Array,Int8Array,Int16Array,Int16Array,Int8Array,Int16Array],{S_001:1,S_1:2,S_R:3,S_R00:4}),I=[void 0,null,!1,!0],N=[NaN],w=function(t,r,e){"object"==typeof r&&(e=r,r=""),this.database=e||{},this.baseDir=r||"",this.queuedRequests=[],this.objectTable=t,this.__delayGC=[]};w.prototype={constructor:w,add:function(t,r){var e="";this.baseDir&&(e=this.baseDir+"/");var i=t.split("?"),n="",s=[];if(i.length>1&&(n="?"+i[1]),".jbbp"===i[0].substr(i[0].length-5).toLowerCase()){var a=e+i[0].substr(0,i[0].length-5);s=[a+".jbbp",a+"_b16.jbbp",a+"_b32.jbbp",a+"_b64.jbbp"]}else{var t=i[0];".jbb"!=t.substr(t.length-4)&&(t+=".jbb"),s=[e+t+n]}var u={callback:r,status:p,buffer:void 0,url:s};this.queuedRequests.push(u)},addByBuffer:function(t){var r={callback:void 0,status:m,buffer:t,url:void 0};this.queuedRequests.push(r)},load:function(t){this.__process(t)},__process:function(t){var r=this;if(t||(t=function(){}),0===this.queuedRequests.length)return void t(null,this);for(var e=!1,i=0;i<this.queuedRequests.length;i++)if(this.queuedRequests[i].status===p){e=!0;break}if(e)for(var n={counter:0},s=function(){0===--this.counter&&r.__process(t)}.bind(n),a=!1,i=0;i<this.queuedRequests.length;i++){var u=this.queuedRequests[i];u.status===p&&(n.counter++,u.buffer=y(u.url,function(r){return function(e){if(e){if(a)return;var i="Error downloading bundle: "+e;return r.callback&&r.callback(i,null),t&&t(i,null),void(a=!0)}r.status=m,s()}}(u)))}else{for(var i=0;i<this.queuedRequests.length;i++){var u=this.queuedRequests[i];if(u.status===m){var o;o=1===u.buffer.length?new T(u.buffer[0],r.objectTable):new T(u.buffer,r.objectTable),d(o,r.database),u.callback&&u.callback(null,u.bundle)}}this.queuedRequests=[],t(null,this),setTimeout(function(){this.__delayGC=[]}.bind(this),500)}}},t.exports=w},function(t,r){"use strict";var e={UINT8:0,INT8:1,UINT16:2,INT16:3,UINT32:4,INT32:5,FLOAT32:6,FLOAT64:7},i=function(t,r){this.ot=r,this.prefix="",this.sparse=t instanceof Array;var e,i,n,s=32;if(this.sparse?(this.u8=new Uint8Array(t[0]),this.s8=new Int8Array(t[0]),this.u16=new Uint16Array(t[1]),this.s16=new Int16Array(t[1]),this.u32=new Uint32Array(t[2]),this.s32=new Int32Array(t[2]),this.f32=new Float32Array(t[2]),this.f64=new Float64Array(t[3]),e=new Uint16Array(t[0],0,s/2),i=new Uint32Array(t[0],0,s/4),n=t[0].byteLength):(this.u8=new Uint8Array(t),this.s8=new Int8Array(t),this.u16=new Uint16Array(t),this.s16=new Int16Array(t),this.u32=new Uint32Array(t),this.s32=new Int32Array(t),this.f32=new Float32Array(t),this.f64=new Float64Array(t),e=new Uint16Array(t),i=new Uint32Array(t),n=t.byteLength),this.magic=e[0],this.table_id=e[1],this.revision=e[2],this.max64=i[2],this.max32=i[3],this.max16=i[4],this.max8=i[5],this.lenST=i[6],this.lenOT=i[7],12610==this.magic)throw{name:"EndianessError",message:"Unfortunately the JBB format is currently only compatible with Little-Endian CPUs",toString:function(){return this.name+": "+this.message}};if(16945!=this.magic)throw{name:"DecodingError",message:"This does not look like a JBB archive! (Magic is 0x"+this.magic.toString(16)+")",toString:function(){return this.name+": "+this.message}};if(this.table_id!=this.ot.ID)throw{name:"DecodingError",message:"The object table specified does not match the object table in the binary bundle (0x"+this.table_id.toString(16)+")",toString:function(){return this.name+": "+this.message}};this.sparse?(this.i64=0,this.i32=0,this.i16=0,this.i8=s,this.iEnd=this.i8+this.max8-this.lenST,this.ofs8=this.i8,this.ofs16=this.i16,this.ofs32=this.i32,this.ofs64=this.i64):(this.i64=s,this.i32=this.i64+this.max64,this.i16=this.i32+this.max32,this.i8=this.i16+this.max16,this.iEnd=this.i8+this.max8-this.lenST,this.ofs8=this.i8,this.ofs16=this.i16,this.ofs32=this.i32,this.ofs64=this.i64,this.i16/=2,this.i32/=4,this.i64/=8),this.iref_table=[];var a="",u=!1;if(this.string_table=[],this.lenST>0){for(var o=this.i8+this.max8,h=o-this.lenST;o>h;h++){var f=this.u8[h];0===f?(this.string_table.push(a),a="",u=!1):(a+=String.fromCharCode(f),u=!0)}u&&this.string_table.push(a)}var l=[],c=0,d=!1;if(this.signature_table=[],this.lenOT>0){for(var o=2*this.i16+this.max16,h=o-this.lenOT;o>h;h+=2){var f=this.u16[h/2];c--?l.push(this.string_table[f]):(d&&this.signature_table.push(l),l=[],c=f,d=!0)}d&&this.signature_table.push(l)}var y=this;this.readTypedNum=[function(){return y.u8[y.i8++]},function(){return y.s8[y.i8++]},function(){return y.u16[y.i16++]},function(){return y.s16[y.i16++]},function(){return y.u32[y.i32++]},function(){return y.s32[y.i32++]},function(){return y.f32[y.i32++]},function(){return y.f64[y.i64++]}],this.sparse?this.readTypedArray=[function(r){var e=y.i8;return y.i8+=r,new Uint8Array(t[0],e,r)},function(r){var e=y.i8;return y.i8+=r,new Int8Array(t[0],e,r)},function(r){var e=2*y.i16;return y.i16+=r,new Uint16Array(t[1],e,r)},function(r){var e=2*y.i16;return y.i16+=r,new Int16Array(t[1],e,r)},function(r){var e=4*y.i32;return y.i32+=r,new Uint32Array(t[2],e,r)},function(r){var e=4*y.i32;return y.i32+=r,new Int32Array(t[2],e,r)},function(r){var e=4*y.i32;return y.i32+=r,new Float32Array(t[2],e,r)},function(r){var e=8*y.i64;return y.i64+=r,new Float64Array(t[3],e,r)}]:this.readTypedArray=[function(r){var e=y.i8;return y.i8+=r,new Uint8Array(t,e,r)},function(r){var e=y.i8;return y.i8+=r,new Int8Array(t,e,r)},function(r){var e=2*y.i16;return y.i16+=r,new Uint16Array(t,e,r)},function(r){var e=2*y.i16;return y.i16+=r,new Int16Array(t,e,r)},function(r){var e=4*y.i32;return y.i32+=r,new Uint32Array(t,e,r)},function(r){var e=4*y.i32;return y.i32+=r,new Int32Array(t,e,r)},function(r){var e=4*y.i32;return y.i32+=r,new Float32Array(t,e,r)},function(r){var e=8*y.i64;return y.i64+=r,new Float64Array(t,e,r)}],this.factory_plain=[],this.factory_plain_bulk=[];for(var h=0;h<this.signature_table.length;h++){for(var T="return {",p=T,m=this.signature_table[h],v=m.length,g=0;v>g;g++)T+="'"+m[g]+"': values["+g+"],",p+="'"+m[g]+"': values["+g+"][i],";T+="}",p+="}",this.factory_plain.push(new Function("values",T)),this.factory_plain_bulk.push(new Function("values","i",p))}};i.prototype.readStringLT=function(){var t=this.readTypedNum[e.UINT16]();if(t>=this.string_table.length)throw{name:"RangeError",message:"String ID is outside than the range of the string lookup table!",toString:function(){return this.name+": "+this.message}};return this.string_table[t]},i.prototype.eof=function(){return this.i8>=this.iEnd},i.prototype.where=function(){console.log("i8=",this.i8-this.ofs8," [U:",this.u8[this.i8],"0x"+this.u8[this.i8].toString(16),"/ S:",this.s8[this.i8],"]"),console.log("i16=",this.i16-this.ofs16/2," [U:",this.u16[this.i16],"/ S:",this.s16[this.i16],"]"),console.log("i32=",this.i32-this.ofs32/4," [U:",this.u32[this.i32],"/ S:",this.s32[this.i32],"/ F:",this.f32[this.i32],"]"),console.log("i64=",this.i64-this.ofs64/8," [F:",this.f64[this.i64],"]")},t.exports=i}]);