<!DOCTYPE html>
<html lang="en">
	<head>
		<title>JBB Browser Tests</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	</head>
	<body>
		<div class="container">
			<h1>JBB Browser Tests</h1>
			<p>Click on the <em>Start Tests</em> button below to download a couple of bundles created using the <code><a href="https://github.com/wavesoft/jbb" target="_blank">jbb</a></code> compiler and the <code><a href="https://github.com/wavesoft/jbb-profile-three" target="_blank">jbb-profile-three</a></code>. You can also click on the bundle name to browse it's contents.</p>
			<p><em>NOTE:</em> It's important to note that the source bundle will be considered 'loaded' even if some resources are still loading (such as images). JBB on the other hand will be considered 'loaded' only when everything is loaded.</p>
			<table class="table">
				<thead>
					<tr>
						<th>Bundle</th>
						<th class="text-center">Source (.jbbsrc)</th>
						<th class="text-center">Compact Bundle (.jbb)</th>
						<th class="text-center">Sparse Bundle (.jbbp)</th>
					</tr>
				</thead>
				<tbody>
					<tr id="times-vrml">
						<th><a href="https://github.com/wavesoft/jbb-tests/tree/master/bundles/vrml.jbbsrc" target="_blank">vrml <span class="glyphicon glyphicon-new-window"></span></a></th>
						<td class="v-source text-center"> --- </td>
						<td class="v-compact text-center"> --- </td>
						<td class="v-sparse text-center"> --- </td>
					</tr>
					<tr id="times-animated">
						<th><a href="https://github.com/wavesoft/jbb-tests/tree/master/bundles/animated.jbbsrc" target="_blank">animated <span class="glyphicon glyphicon-new-window"></span></a></th>
						<td class="v-source text-center"> --- </td>
						<td class="v-compact text-center"> --- </td>
						<td class="v-sparse text-center"> --- </td>
					</tr>
					<tr id="times-heavy">
						<th><a href="https://github.com/wavesoft/jbb-tests/tree/master/bundles/heavy.jbbsrc" target="_blank">heavy <span class="glyphicon glyphicon-new-window"></span></a></th>
						<td class="v-source text-center"> --- </td>
						<td class="v-compact text-center"> --- </td>
						<td class="v-sparse text-center"> --- </td>
					</tr>
					<tr id="times-md2">
						<th><a href="https://github.com/wavesoft/jbb-tests/tree/master/bundles/md2.jbbsrc" target="_blank">md2 <span class="glyphicon glyphicon-new-window"></span></a></th>
						<td class="v-source text-center"> --- </td>
						<td class="v-compact text-center"> --- </td>
						<td class="v-sparse text-center"> --- </td>
					</tr>
				</tbody>
			</table>
			<p>
				<button id="start-tests" class="btn btn-default">Start Tests</button>
			</p>
		</div>

		<script src="//cdnjs.cloudflare.com/ajax/libs/three.js/r73/three.min.js"></script>
		<script src="//code.jquery.com/jquery-2.2.0.min.js"></script>
		<script src="build/jbb.min.js"></script>
		<script src="build/jbb-loader.min.js"></script>
		<script src="build/jbb-profile-three.min.js"></script>
		<script src="build/jbb-profile-three-loader.min.js"></script>

		<script>

		/**
		 * Run test by trying to load the source and the binary
		 */
		function run_test( bundle, row, callback ) {

			// Instantiate a new bundles loader
			var sourceLoader = new JBBSourceLoader( 'bundles' );
			sourceLoader.addProfileLoader( JBBProfileThreeLoader );
			// Instantiate a new binary decoder
			var binaryLoader = new JBBBinaryLoader( 'build/bundles' );
			binaryLoader.addProfile( JBBProfileThree );

			// Run timing tests for source
			var load_source = function( cb ){
				console.time("source["+bundle+"]");
				sourceLoader.add( bundle );
				sourceLoader.load(function() {
					console.timeEnd("source["+bundle+"]");
					cb();
				});
			};

			// Run timing tests for binary
			var load_binary = function( cb ){
				console.time("compact["+bundle+"]");
				binaryLoader.add( bundle+'.jbb');
				binaryLoader.load(function() {
					console.timeEnd("compact["+bundle+"]");
					cb();
				});
			}

			// Run timing tests for binary
			var load_sparse_binary = function( cb ){
				console.time("sparse["+bundle+"]");
				binaryLoader.add( bundle+'.jbbp');
				binaryLoader.load(function() {
					console.timeEnd("sparse["+bundle+"]");
					cb();
				});
			}

			// Reset rows
			row.find(".v-source").text("Running...");
			row.find(".v-compact").text("Running...");
			row.find(".v-sparse").text("Running...");

			// Run binary first
			var loadStart = Date.now();
			load_source(function() {
				var referenceDelta = Date.now() - loadStart;
				row.find(".v-source").html( referenceDelta + " ms");

				// Wait a sec
				setTimeout(function() {
					// Load source
					var loadStart = Date.now();
					load_binary(function() {
						var loadDelta = Date.now() - loadStart;

						// Calculate delta
						var percent = ((referenceDelta - loadDelta) / referenceDelta) * 100;
						if (percent > 0) {
							row.find(".v-compact").html( loadDelta + ' ms <span class="text-success">( +'+percent.toFixed(2)+' % )</span>');
						} else {
							row.find(".v-compact").html( loadDelta + ' ms <span class="text-danger">( '+percent.toFixed(2)+' % )</span>');
						}

						// Wait a sec
						setTimeout(function() {
							// Load source
							var loadStart = Date.now();
							load_sparse_binary(function() {
								var loadDelta = Date.now() - loadStart;

								// Calculate delta
								var percent = ((referenceDelta - loadDelta) / referenceDelta) * 100;
								if (percent > 0) {
									row.find(".v-sparse").html( loadDelta + ' ms <span class="text-success">( +'+percent.toFixed(2)+' % )</span>');
								} else {
									row.find(".v-sparse").html( loadDelta + ' ms <span class="text-danger">( '+percent.toFixed(2)+' % )</span>');
								}

								// Trigger callback after a sec
								setTimeout( callback, 1000 );

							});
						}, 1000);

					});
				}, 1000);

			});

		}

		// Bind on click
		$(function() {

			$("button#start-tests").click(function() {

				// Chain-run all tests
				run_test("vrml", $("#times-vrml"), function() {
					run_test("animated", $("#times-animated"), function() {
						run_test("heavy", $("#times-heavy"), function() {
							run_test("md2", $("#times-md2"), function() {

							});
						});
					});
				});

			});

		});

		</script>

	</body>
</html>